#!/bin/bash

##############################################################################
# Git Post-Receive Hook
#
# This hook is triggered after code is pushed to the production server.
# It checks if the 'prod' branch was updated and triggers deployment.
#
# Installation:
#   1. Copy this file to: /var/www/sunnysideac.git/hooks/post-receive
#   2. Make it executable: chmod +x /var/www/sunnysideac.git/hooks/post-receive
##############################################################################

# Configuration
GIT_DIR="/var/www/sunnyside247ac_com.git"
WORK_TREE="/var/www/sunnyside247ac_com"
DEPLOY_SCRIPT="${WORK_TREE}/.deployment/deploy.sh"
TARGET_BRANCH="prod"

# Read pushed branch
while read oldrev newrev refname; do
    # Extract branch name from ref (refs/heads/prod -> prod)
    branch=$(echo "$refname" | sed 's:refs/heads/::')

    echo "==> Received push to branch: $branch"

    # Only deploy if prod branch was pushed
    if [ "$branch" = "$TARGET_BRANCH" ]; then
        echo "==> Triggering deployment for $TARGET_BRANCH branch..."

        # First, check out the code to the working tree
        echo "==> Checking out code to working tree..."
        git --git-dir="$GIT_DIR" --work-tree="$WORK_TREE" checkout -f "$TARGET_BRANCH" || {
            echo "ERROR: Failed to checkout code"
            exit 1
        }

        # Execute deployment script
        if [ -f "$DEPLOY_SCRIPT" ]; then
            bash "$DEPLOY_SCRIPT"
        else
            echo "ERROR: Deploy script not found at $DEPLOY_SCRIPT"
            exit 1
        fi
    else
        echo "==> Branch $branch is not the deployment branch ($TARGET_BRANCH), skipping deployment"
    fi
done
